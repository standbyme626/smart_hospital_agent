# 升级2接力索引（2026-02-28）

## 1. 外部仓库固定位置
- `vercel-ai-chatbot`: `/home/kkk/Project/vercel-ai-chatbot` (`866ba32`)
- `open-webui`: `/home/kkk/Project/open-webui` (`1ac3dd4a8`)
- `langfuse`: `/home/kkk/Project/langfuse` (`258a41a1f`)

## 2. 本仓库新增文档
- 升级2主文档：`/home/kkk/Project/smart_hospital_agent/升级2.md`
- 接力索引：`/home/kkk/Project/smart_hospital_agent/升级2_接力索引.md`

## 3. 已执行验证
- 后端重启后 E2E 跑批：
  - `logs/e2e_fullchain/20260228_165836/summary.json`
  - `logs/e2e_fullchain/20260228_165836/report.md`
- 结果：`4` 个用例通过 `3` 个；`mt_turn4_crisis` 在 `Query_Rewrite` `stall_timeout`

## 4. 关键代码入口（下一对话优先读）
- 升级1诊断子图：
  - `/home/kkk/Project/smart_hospital_agent/backend/app/core/graph/sub_graphs/diagnosis.py`
- 前端壳吸收位：
  - `/home/kkk/Project/vercel-ai-chatbot/components/chat.tsx`
  - `/home/kkk/Project/vercel-ai-chatbot/components/data-stream-handler.tsx`
  - `/home/kkk/Project/vercel-ai-chatbot/app/(chat)/api/chat/route.ts`
- 过渡 UI 与观测部署位：
  - `/home/kkk/Project/open-webui/docker-compose.yaml`
  - `/home/kkk/Project/langfuse/docker-compose.yml`

## 5. 建议下一步执行命令
```bash
# 1) 复核升级2计划
sed -n '1,260p' /home/kkk/Project/smart_hospital_agent/升级2.md

# 2) 复跑全链路
cd /home/kkk/Project/smart_hospital_agent
python scripts/e2e_fullchain_logger.py \
  --project-root . \
  --base-url http://127.0.0.1:8001 \
  --cases-file scripts/e2e_cases_multiturn.json

# 3) 实施前端壳接入（建议新目录）
cp -r /home/kkk/Project/vercel-ai-chatbot /home/kkk/Project/smart_hospital_agent/frontend_upgrade2_shell
```

## 6. P2 本轮落地（2026-02-28）
- P2-1（最小 RBAC + 审计 + SSO 映射）
  - `backend/app/core/security/rbac.py`
  - `backend/app/core/security/auth_audit.py`
  - `backend/app/api/v1/endpoints/auth.py`
  - `backend/app/api/v1/endpoints/admin_rules.py`
  - `backend/app/api/v1/endpoints/evolution.py`
  - `docs/upgrade2_p2_auth_sso.md`
- P2-2（自动化发布看板）
  - `scripts/build_release_dashboard.py`
  - 产物：`logs/release_dashboard/release_dashboard_latest.json|md`
- P2-3（Open WebUI 对照组制度化）
  - `scripts/openwebui_control_rerun.py`
  - `scripts/run_shell_regression_gate.py`
  - 示例产物：`logs/e2e_fullchain/20260228_185032/openwebui_control_report.json|md`
