1) 升级2定位（基于 2026-02-28 已拉取代码）

升级2不是替换后端诊断链路，而是补齐三块“产品化短板”：
- 前端壳与流式交互（Vercel Next.js AI Chatbot）。
- 过渡期可用 UI 与知识库运营台（Open WebUI）。
- 诊断链路可观测、可回放、可评估（Langfuse）。

结论：
- 升级1解决“诊断链路能力与治理”。
- 升级2解决“可用界面 + 可观测运营 + 团队协作落地”。


2) 外部项目对当前项目的作用分析

2.1 Vercel AI Chatbot（/home/kkk/Project/vercel-ai-chatbot @ 866ba32）
- 作用1：提供完整、可维护的 Next.js 前端骨架（`app/`、`components/`、`lib/`、`hooks/`）。
- 作用2：已有成熟流式消息处理组件，可快速适配现有 `/api/v1/chat/stream`。
- 作用3：会话历史、输入组件、模型选择、鉴权页面可直接改造复用。
- 当前价值：最快补齐“面向内部试用”的前端壳。

2.2 Open WebUI（/home/kkk/Project/open-webui @ 1ac3dd4a8）
- 作用1：可直接部署的产品级 UI（聊天、模型、知识入口、管理页）。
- 作用2：低改造成本提供“业务可用界面”，缓解前端开发窗口期。
- 作用3：可借鉴信息架构（会话、权限、知识库入口）反哺自研前端。
- 当前价值：过渡期“先可用再精修”方案。

2.3 Langfuse（/home/kkk/Project/langfuse @ 258a41a1f）
- 作用1：将升级1中的 `Query_Rewrite/Hybrid_Retriever/Decision_Judge` 变成可视化 trace。
- 作用2：支持评估看板与回放，缩短排障和回归定位时间。
- 作用3：为发布门禁提供审计证据链（trace-id ↔ request_id ↔ gate 报告）。
- 当前价值：补齐升级1“有能力但观测薄弱”的运营缺口。


3) 升级2计划书（与升级1一致：增量吸收，不换主内核）

0. 目标（2026 Q2）
- 目标1：交付可用聊天前端壳，支持现有 SSE 协议与多轮会话。
- 目标2：交付过渡型 UI（Open WebUI）供业务/测试团队先跑流程。
- 目标3：交付 LangGraph 关键节点可观测与回放能力（Langfuse）。
- 目标4：不破坏升级1诊断主流程与安全边界。

1. 为什么现在做
- 升级1开关已全开，但全链路验证显示仍有卡点：
  - `logs/e2e_fullchain/20260228_165836/summary.json` 中 `Query_Rewrite` 平均 37.112s，最大 60.43s。
  - `mt_turn4_crisis` 用例 `stall_timeout`（63.071s）。
- 当前缺少强前端承载与可观测平台，定位慢、协作成本高。

1.1 建议评审结论（本轮）
| 建议 | 与当前现状匹配度 | 是否纳入升级2 |
| --- | --- | --- |
| SSE 双协议兼容 + request_id 全链路贯穿 | 高：现有链路存在新旧事件共存，且报告/日志关联不足 | 纳入（P0） |
| Next.js API route 纯代理+解析+兜底 | 高：与现有 Vercel 壳接入方案完全一致 | 纳入（P0） |
| Langfuse 最小 1 trace + 3 spans | 高：可直接覆盖当前卡点节点 | 纳入（P0） |
| crisis 快速专线 + rewrite 超时 fallback | 高：直接对应当前 E2E 失败点 | 纳入（P0） |
| 前端设置页 + 评估联动 + rewrite 缓存 | 中高：产品化与运维效率收益明显 | 纳入（P1） |
| SSE 契约新增 `seq`、`stage` 字段 | 高：有助于乱序/断流恢复和看板聚合 | 纳入（P0） |
| SSE 心跳保活 + 明确终止标记 | 高：直接影响前端“卡转圈/假死”问题 | 纳入（P0） |
| 代理层 cancel + 超时治理 | 高：直接影响成本与排队稳定性 | 纳入（P0） |
| 分段时延指标（connect/first_token/final） | 高：定位瓶颈必需 | 纳入（P0） |
| Langfuse 脱敏规则可执行化 | 高：合规落地必需 | 纳入（P0） |
| Open WebUI 反代 HTTPS + 安全版本线 | 高：部署安全基线 | 纳入（P0） |
| request_id 中间件固化 | 高：防止并发链路丢关联键 | 纳入（P0） |
| 一键回放闭环（报告↔trace↔日志） | 中高：排障效率提升显著 | 纳入（P1） |
| 配置中心化可追踪（生效配置上报） | 中高：避免“显示配置≠生效配置” | 纳入（P1） |
| rewrite 分级策略（规则/LLM） | 中高：兼顾时延与效果 | 纳入（P1） |
| Open WebUI 对照组回归制度化 | 中：长期质量保障 | 纳入（P2） |
| RBAC 审计先行后 SSO | 中：降低长周期改造风险 | 纳入（P2） |

结论补充（可直接执行）：
- P0 再补：SSE 心跳与终止、cancel/超时治理、分段时延、masking 规则、Open WebUI HTTPS 反代、安全版本线、request_id 中间件固化。
- P1 再补：一键回放闭环、配置中心化可追踪、rewrite 分级策略。
- P2 再补：Open WebUI 对照组回归制度、先 RBAC 审计后 SSO。

2. To-Be 架构原则
- 不替换后端：保留 FastAPI + LangGraph + 现有 RAG 栈。
- 双轨前端：短期 Open WebUI 保可用，中期 Vercel 壳做主前端。
- 观测先行：Langfuse 覆盖 Query_Rewrite/Retriever/Guardrail/Decision。
- 协议收敛：统一 SSE 事件契约，但先双协议兼容，再渐进收敛。
- 关联键优先：`request_id` 作为日志/SSE/trace/报告统一主键。
- 可回退：任何新增集成都有独立 feature flag 和旁路回退路径。

2.1 强制吸收清单（优先级）

P0（必须）

P0-1 SSE 事件契约（先兼容，再收敛）
- 契约策略：
  - 前端 parser 双协议兼容：优先新 JSON 事件，同时兼容后端现有 SSE 老格式。
  - 后端逐步统一：先确保每条关键事件至少带 `request_id/type/node`，不强制一次性全改。
- `request_id` 生成与传播（必须）：
  - 在入口层中间件或 chat endpoint 生成 `request_id`（并发安全、全局唯一）。
  - 将 `request_id` 自动注入后续日志上下文，禁止节点自行重复生成。
- `request_id` 贯穿范围（必须）：
  - SSE 每条事件
  - 后端结构化日志
  - Langfuse trace metadata
  - E2E 与 gate 报告产物
- DoD：
  - 同一请求在 SSE、日志、trace、报告中可通过 `request_id` 一键关联。

P0-2 Vercel AI Chatbot 前端壳适配（Next.js 代理层）
- 吸收模块：
  - `components/chat.tsx`
  - `components/messages.tsx`
  - `components/multimodal-input.tsx`
  - `app/(chat)/api/chat/route.ts`（改造成后端代理）
- 改造点：
  - 将默认 `api: "/api/chat"` 改为代理 `/api/v1/chat/stream`。
  - 代理层透传 request/trace 相关 headers。
  - 处理断连/超时并输出稳定错误事件。
  - UI Stop 时通过 `AbortController` 触发取消，代理层向后游传播中止信号。
  - 增加事件 parser（thought/token/final/error/status）。
  - 支持“final 缺失时”按 token 聚合兜底收敛。
- DoD：
  - 医疗咨询/挂号/危机场景都能在前端稳定流式展示。

P0-3 Langfuse 可观测接入（最小可定位集）
- 吸收方式：先用官方部署，后做关键节点埋点。
- 最小结构：
  - 1 条入口 trace（绑定 `request_id/session_id/user_intent`）
  - 3 个关键 spans：`Query_Rewrite` / `Hybrid_Retriever` / `Decision_Judge`
- span 字段建议（用于直接定位 stall）：
  - Query_Rewrite：`input_len/variant_count/timeout_config/elapsed_ms/fallback_used`
  - Hybrid_Retriever：`query_variants/vector_k/bm25_k/rrf/rerank_elapsed_ms/final_docs_count`
  - Decision_Judge：`decision_action/confidence/guardrail_hit/elapsed_ms`
- 脱敏规则（必须落地为执行规则）：
  - prompts/messages：仅上报 hash/摘要/长度/类别，不上报原文。
  - tool input/output：按字段白名单上报，默认拒绝明文透传。
  - error：剔除原始输入正文，仅保留错误码与摘要。
- DoD：
  - 任何一次 `stall_timeout` 可在 Langfuse 完整回放并定位卡点节点。

P0-4 crisis 超时硬兜底（保障 DoD4）
- 机制（必须）：
  - crisis 快速专线：危机意图跳过慢 rewrite（或仅规则轻改写），直进检索与裁决。
  - rewrite 强制超时 + fallback：建议 3-5s；超时后自动回退原 query/规则清洗 query。
  - rewrite 失败不阻断：任何异常都必须降级到“无 rewrite 检索”。
- 输出（必须）：
  - 在 SSE 与 Langfuse 打标：`rewrite_fallback=true`、`fallback_reason=timeout|error`。
- DoD：
  - 危机场景不再因 `Query_Rewrite` 导致全链路 stall timeout。

P0-5 Open WebUI 过渡部署
- 吸收方式：直接部署，不做深度二开。
- 关键动作：
  - 对接你方模型 API 网关或 OpenAI 兼容入口。
  - 预置测试账号与最小权限策略。
  - 通过反向代理统一 HTTPS、CORS 与访问控制（内部试用同样执行）。
  - 跟随上游安全版本，默认关闭不必要的直连能力。
  - 作为内部验证入口，不绑定最终产品路由。
- DoD：
  - 内部团队可用单一 UI 跑聊天、知识问答、基础管理流程。

P0-6 SSE 连接治理与分段时延观测
- 连接治理（必须）：
  - 增加 `ping/keep-alive`（或等价 status 心跳）避免空闲断连。
  - 流结束必须发送明确终止标记（`final` 或协议终止事件）。
- 超时与取消（必须）：
  - 代理层设置连接、首包、总时长超时。
  - 用户取消后及时中止后端 rewrite/LLM 调用，避免算力空耗。
- 时延指标（必须）：
  - 上报 `t_connect/t_first_event/t_first_token/t_final`。
  - 指标同时进入 SSE status、日志与 Langfuse metadata。
- DoD：
  - 断流、长尾、卡顿可被快速归因到“后端/代理/前端解析”具体层。

P1（强烈建议）
- P1-1 前端设置页：把常用参数放入 UI 可控入口。
  - 建议首批：`debug_include_nodes/top_k/rerank_threshold/rewrite_timeout/crisis_fastlane`
- P1-2 评估联动：`weekly_baseline/e2e` 报告与 Langfuse trace 通过 `request_id` 自动关联。
- P1-3 rewrite 缓存：将高重复 rewrite 结果纳入缓存层，降低平均 rewrite 时延。
- P1-4 Open WebUI 对照组：用于排查“UI代理问题 vs 后端链路问题”。
- P1-5 一键回放闭环：
  - 每条 trace 提供日志检索入口（按 `request_id`）与 e2e/gate 报告反链。
  - 保存运行配置快照（开关、top_k、timeout、fastlane）。
- P1-6 配置中心化可追踪：
  - 前端设置页展示值与后端“最终生效值”同时上报到 SSE status + Langfuse metadata。
- P1-7 rewrite 分级策略：
  - 危机/高风险意图：仅规则改写或禁用 LLM rewrite。
  - 普通意图：允许 LLM rewrite，但强制超时与降级。

P2（可选）
- P2-1 统一鉴权演进路径：先最小 RBAC + 审计，再做自研前端与 Open WebUI 的 SSO 映射。
- P2-2 自动化发布看板：E2E、Gate、Dynamic Regression 三报告聚合展示。
- P2-3 Open WebUI 对照组回归制度化：
  - 任意“前端壳回归失败”用例必须在 Open WebUI 复跑一次，先判定问题边界（UI/代理 vs 后端）。

2.2 契约与接口（升级2新增）

SSE 前端统一事件契约（建议）
```json
{
  "type": "thought|token|final|error|status|ping",
  "node": "Query_Rewrite|Hybrid_Retriever|Decision_Judge|...",
  "request_id": "req-xxx",
  "seq": 1,
  "stage": "rewrite|retrieve|judge|respond",
  "ts": "2026-02-28T17:00:00Z",
  "payload": {}
}
```

观测关联键（必须）
- `request_id`：后端日志、Langfuse trace、gate 报告三方统一主键。
- `session_id`：多轮上下文复盘主键。

时延拆分指标（必须）
- `t_connect`：连接建立耗时
- `t_first_event`：首个 SSE 事件耗时
- `t_first_token`：首个 token 耗时
- `t_final`：最终完成耗时

备注（工程实现）
- 浏览器 `EventSource` 在 header 控制等方面受限，使用 Next.js API route 代理是默认推荐路径。


4) 路线图（升级2：A/B/C/D）

阶段 A（P0）：外部仓库引入与路径固化（已完成）
- 已拉取：
  - `/home/kkk/Project/vercel-ai-chatbot`
  - `/home/kkk/Project/open-webui`
  - `/home/kkk/Project/langfuse`
- 输出：本文件 + 接力索引文件。

阶段 B（P0）：后端重启与升级1全开验证（已执行）
- 已执行：
  - 重启 `uvicorn app.main:app --port 8001`
  - 运行 `scripts/e2e_fullchain_logger.py`
- 结果：
  - 4/4 用例通过 3 个
  - crisis 场景在 `Query_Rewrite` 卡住导致超时

阶段 C（P0/P1）：前端壳接入（待实施）
- C1：后端最小事件字段统一（`request_id/type/node` 必达）。
- C2：基于 Vercel chat 壳建立 `frontend_new_v2`（或替换现有壳）。
- C3：新增 Next.js API route 纯代理 + 双协议 parser + final 兜底。
- C4：补齐心跳/终止/cancel 机制，并完成断连恢复压测。
- C5：上报分段时延指标（connect/first_event/first_token/final）。

阶段 D（P0/P1）：可观测 + 过渡 UI（待实施）
- D1：部署 Langfuse 并完成“1 trace + 3 spans”最小埋点。
- D2：落地 crisis 快速专线 + rewrite 超时 fallback。
- D3：落地 masking 执行规则与敏感字段白名单。
- D4：部署 Open WebUI（反代 HTTPS）作为临时业务入口与对照组 UI。
- D5：将 E2E 失败场景（crisis）做 trace 回放复盘并闭环修复。


5) 边界与非目标（升级2）
- 非目标1：不替换现有 FastAPI/LangGraph 主流程。
- 非目标2：不在本阶段重写医疗决策规则。
- 非目标3：不把 Open WebUI 当最终自研前端代码基座长期二开。


6) 风险与应对
- 风险：双前端并存导致维护复杂。
  - 应对：明确 Open WebUI 为过渡入口，Vercel 壳为主线。
- 风险：Langfuse 接入扩大数据暴露面。
  - 应对：默认脱敏，仅上报 hash/id/摘要，不上报患者原文。
- 风险：SSE 长连接在代理链路被空闲断开。
  - 应对：心跳保活 + 明确终止 + cancel/timeout 治理。
- 风险：Open WebUI 以默认直连方式部署扩大暴露面。
  - 应对：统一反代 HTTPS，按安全版本线升级并关闭不必要直连能力。
- 风险：crisis 继续超时。
  - 应对：危机意图走快速专线，禁用慢 rewrite 扩展路径。


7) 升级2 DoD（完成定义）
- DoD1：新前端壳可稳定流式联调（含多轮）。
- DoD2：Open WebUI 可作为内部可用入口。
- DoD3：Langfuse 可查看关键节点 trace 并支持问题回放。
- DoD4：E2E 危机场景不再出现 `Query_Rewrite` stall timeout。


8) 吸收映射表（能力形态）

| 升级2能力 | 来源项目 | 吸收方式 |
| --- | --- | --- |
| Chat Shell + Streaming UI | vercel/ai-chatbot | 复制前端壳与流式组件，改造 API 代理 |
| 过渡期产品 UI | open-webui/open-webui | 直接部署，最小配置对接 |
| 可观测与评估回放 | langfuse/langfuse | 自部署 + SDK 埋点接入 |


9) 当前已验证事实（2026-02-28）
- 三个仓库已拉取到 `/home/kkk/Project`。
- 升级1新 `.env` 开关已生效并进入执行路径（E2E 中已出现 `Query_Rewrite`、`Decision_Judge`）。
- 全链路报告路径：
  - `logs/e2e_fullchain/20260228_165836/summary.json`
  - `logs/e2e_fullchain/20260228_165836/report.md`


附录A. 固定路径（供后续对话接力）
- Vercel AI Chatbot: `/home/kkk/Project/vercel-ai-chatbot`
- Open WebUI: `/home/kkk/Project/open-webui`
- Langfuse: `/home/kkk/Project/langfuse`

附录B. 关键文件定位
- Vercel chat 核心：
  - `/home/kkk/Project/vercel-ai-chatbot/components/chat.tsx`
  - `/home/kkk/Project/vercel-ai-chatbot/components/data-stream-handler.tsx`
  - `/home/kkk/Project/vercel-ai-chatbot/app/(chat)/api/chat/route.ts`
- Open WebUI 部署：
  - `/home/kkk/Project/open-webui/docker-compose.yaml`
- Langfuse 部署：
  - `/home/kkk/Project/langfuse/docker-compose.yml`
